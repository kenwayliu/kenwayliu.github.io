<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Nginx调优参数 | 猫在云端</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一般来说nginx 配置文件中对优化比较有作用的为以下几项：
配置文件优化">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx调优参数">
<meta property="og:url" content="http://cloudbps.com/2015/01/10/nginx_tun/">
<meta property="og:site_name" content="猫在云端">
<meta property="og:description" content="一般来说nginx 配置文件中对优化比较有作用的为以下几项：
配置文件优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nginx调优参数">
<meta name="twitter:description" content="一般来说nginx 配置文件中对优化比较有作用的为以下几项：
配置文件优化">

  
    <link rel="alternative" href="/atom.xml" title="猫在云端" type="application/atom+xml">
  
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="overlay"></div>
  <div id="header-outer" class="outer">
    <div id="profile_img">
      <img id="circle_img" src="http://7sbxwp.com1.z0.glb.clouddn.com/aboutme?v=2&amp;s=150" />
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">猫在云端</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">做自己喜欢做的事，相信自己</a>
        </h2>
      
    </div>
    <div id="header-menu">
      <nav id="main-nav">
        <ul>
        
          <li><a href="/"><i class="fa fa-home icon-setting"></i></a></li>
        
          <li><a href="/archives"><i class="fa fa-archive icon-setting"></i></a></li>
        
          <li><a href="/about"><i class="fa fa-user icon-setting"></i></a></li>
        
        
          <li><a href="/atom.xml"><i class="fa fa-rss %> icon-setting"></i></a></li>
        
        </ul>
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-nginx_tun" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/10/nginx_tun/" class="article-date">
  <time datetime="2015-01-10T04:44:33.000Z" itemprop="datePublished">1月 10 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Nginx调优参数
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一般来说nginx 配置文件中对优化比较有作用的为以下几项：</p>
<h3 id="配置文件优化">配置文件优化</h3>
<a id="more"></a>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">worker_processes <span class="number">8</span>;</div><div class="line"></div><div class="line">nginx 进程数，建议按照cpu 数目来指定，一般为它的倍数。</div><div class="line"></div><div class="line">worker_cpu_affinity <span class="number">00000001</span> <span class="number">00000010</span> <span class="number">00000100</span> <span class="number">00001000</span> <span class="number">00010000</span> <span class="number">00100000</span></div><div class="line"><span class="number">01000000</span> <span class="number">10000000</span>;</div><div class="line"></div><div class="line">为每个进程分配cpu，上例中将 <span class="number">8</span> 个进程分配到 <span class="number">8</span> 个 cpu，当然可以写多个，或者将一</div><div class="line">个进程分配到多个 cpu。</div><div class="line"></div><div class="line">worker_rlimit_nofile <span class="number">102400</span>;</div><div class="line"></div><div class="line">这个指令是指当一个 nginx 进程打开的最多文件描述符数目，理论值应该是最多打开文</div><div class="line">件数（ulimit -n）与 nginx 进程数相除，但是 nginx 分配请求并不是那么均匀，所以最好与 ulimit</div><div class="line">-n 的值保持一致。</div><div class="line">use epoll;</div><div class="line"></div><div class="line">使用epoll 的<span class="constant">I</span>/<span class="constant">O</span> 模型，这个不用说了吧。</div><div class="line"></div><div class="line">worker_connections <span class="number">102400</span>;</div><div class="line"></div><div class="line">每个进程允许的最多连接数 ，理论上每台 nginx 服务器的最大连接数为</div><div class="line">worker_processes*worker_connections。</div><div class="line"></div><div class="line">keepalive_timeout <span class="number">60</span>;</div><div class="line"></div><div class="line">keepalive 超时时间。</div><div class="line"></div><div class="line">client_header_buffer_size <span class="number">4</span>k;</div><div class="line"></div><div class="line">客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般一个请求</div><div class="line">头的大小不会超过 <span class="number">1</span>k，不过由于一般系统分页都要大于 <span class="number">1</span>k，所以这里设置为分页大小。分</div><div class="line">页大小可以用命令getconf <span class="constant">PAGESIZE</span> 取得。</div><div class="line"></div><div class="line">open_file_cache max=<span class="number">102400</span> inactive=<span class="number">20</span>s;</div><div class="line"></div><div class="line">这个将为打开文件指定缓存，默认是没有启用的，max 指定缓存数量，建议和打开文件</div><div class="line">数一致，inactive 是指经过多长时间文件没被请求后删除缓存。</div><div class="line"></div><div class="line">open_file_cache_valid <span class="number">30</span>s;</div><div class="line"></div><div class="line">这个是指多长时间检查一次缓存的有效信息。</div><div class="line"></div><div class="line">open_file_cache_min_uses <span class="number">1</span>;</div><div class="line"></div><div class="line">open_file_cache 指令中的 inactive 参数时间内文件的最少使用次数，如果超过这个数字，文</div><div class="line">件描述符一直是在缓存中打开的，如上例，如果有一个文件在 inactive 时间内一次没被使用，</div><div class="line">它将被移除。</div></pre></td></tr></table></figure>

<h4 id="内核优化">内核优化</h4>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">关于内核参数的优化：</div><div class="line"></div><div class="line">net.ipv4.tcp_max_tw_buckets = <span class="number">6000</span></div><div class="line"></div><div class="line">timewait 的数量，默认是 <span class="number">180000</span>。</div><div class="line"></div><div class="line">net.ipv4.ip_local_port_range = <span class="number">1024</span> <span class="number">65000</span></div><div class="line"></div><div class="line">允许系统打开的端口范围。</div><div class="line"></div><div class="line">net.ipv4.tcp_tw_recycle = <span class="number">1</span></div><div class="line"></div><div class="line">启用timewait 快速回收。</div><div class="line"></div><div class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span></div><div class="line"></div><div class="line">开启重用。允许将<span class="constant">TIME</span>-<span class="constant">WAIT</span> sockets 重新用于新的<span class="constant">TCP</span> 连接。</div><div class="line"></div><div class="line">net.ipv4.tcp_syncookies = <span class="number">1</span></div><div class="line"></div><div class="line">开启<span class="constant">SYN</span> <span class="constant">Cookies</span>，当出现<span class="constant">SYN</span> 等待队列溢出时，启用cookies 来处理。</div><div class="line"></div><div class="line">net.core.somaxconn = <span class="number">262144</span></div><div class="line"></div><div class="line">web 应用中 listen 函数的 backlog 默认会给我们内核参数的 net.core.somaxconn 限制到</div><div class="line"><span class="number">128</span>，而 nginx 定义的 <span class="constant">NGX_LISTEN_BACKLOG</span> 默认为<span class="number">511</span>，所以有必要调整这个值。</div><div class="line"></div><div class="line">net.core.netdev_max_backlog = <span class="number">262144</span></div><div class="line"></div><div class="line">每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包</div><div class="line">的最大数目。</div><div class="line"></div><div class="line">net.ipv4.tcp_max_orphans = <span class="number">262144</span></div><div class="line"></div><div class="line">系统中最多有多少个<span class="constant">TCP</span> 套接字不被关联到任何一个用户文件句柄上。如果超过这个数</div><div class="line">字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的 <span class="constant">DoS</span> 攻击，</div><div class="line">不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。</div><div class="line"></div><div class="line">net.ipv4.tcp_max_syn_backlog = <span class="number">262144</span></div><div class="line"></div><div class="line">记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有 <span class="number">128</span>M 内存的系统而</div><div class="line">言，缺省值是 <span class="number">1024</span>，小内存的系统则是 <span class="number">128</span>。</div><div class="line"></div><div class="line">net.ipv4.tcp_timestamps = <span class="number">0</span></div><div class="line"></div><div class="line">时间戳可以避免序列号的卷绕。一个 <span class="number">1</span>Gbps 的链路肯定会遇到以前用过的序列号。时间</div><div class="line">戳能够让内核接受这种 “异常”的数据包。这里需要将其关掉。</div><div class="line"></div><div class="line">net.ipv4.tcp_synack_retries = <span class="number">1</span></div><div class="line"></div><div class="line">为了打开对端的连接，内核需要发送一个<span class="constant">SYN</span> 并附带一个回应前面一个<span class="constant">SYN</span> 的<span class="constant">ACK</span>。也</div><div class="line">就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送 <span class="constant">SYN</span>+<span class="constant">ACK</span> 包的</div><div class="line">数量。</div><div class="line"></div><div class="line">net.ipv4.tcp_syn_retries = <span class="number">1</span></div><div class="line"></div><div class="line">在内核放弃建立连接之前发送<span class="constant">SYN</span> 包的数量。</div><div class="line"></div><div class="line">net.ipv4.tcp_fin_timeout = <span class="number">1</span></div><div class="line"></div><div class="line">如果套接字由本端要求关闭，这个参数决定了它保持在 <span class="constant">FIN</span>-<span class="constant">WAIT</span>-<span class="number">2</span> 状态的时间。对端</div><div class="line">可以出错并永远不关闭连接，甚至意外当机。缺省值是 <span class="number">60</span> 秒。<span class="number">2.2</span> 内核的通常值是<span class="number">180</span> 秒，</div></pre></td></tr></table></figure>

<h4 id="针对nginx完整的内核优化">针对nginx完整的内核优化</h4>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">你可以按这个设置，但要记住的是，即使你的机器是一个轻载的 <span class="constant">WEB</span> 服务器，也有因为大</div><div class="line">量的死套接字而内存溢出的风险，<span class="constant">FIN</span>- <span class="constant">WAIT</span>-<span class="number">2</span> 的危险性比<span class="constant">FIN</span>-<span class="constant">WAIT</span>-<span class="number">1</span> 要小，因为它最多只</div><div class="line">能吃掉 <span class="number">1.5</span>K 内存，但是它们的生存期长些。</div><div class="line"></div><div class="line">net.ipv4.tcp_keepalive_time = <span class="number">30</span></div><div class="line"></div><div class="line">当keepalive 起用的时候，<span class="constant">TCP</span> 发送 keepalive 消息的频度。缺省是 <span class="number">2</span> 小时。</div><div class="line"></div><div class="line">下面贴一个完整的内核优化设置：</div><div class="line"></div><div class="line">net.ipv4.ip_forward = <span class="number">0</span></div><div class="line">net.ipv4.conf.default.rp_filter = <span class="number">1</span></div><div class="line">net.ipv4.conf.default.accept_source_route = <span class="number">0</span></div><div class="line">kernel.sysrq = <span class="number">0</span></div><div class="line">kernel.core_uses_pid = <span class="number">1</span></div><div class="line">net.ipv4.tcp_syncookies = <span class="number">1</span></div><div class="line">kernel.msgmnb = <span class="number">65536</span></div><div class="line">kernel.msgmax = <span class="number">65536</span></div><div class="line">kernel.shmmax = <span class="number">68719476736</span></div><div class="line">kernel.shmall = <span class="number">4294967296</span></div><div class="line">net.ipv4.tcp_max_tw_buckets = <span class="number">6000</span></div><div class="line">net.ipv4.tcp_sack = <span class="number">1</span></div><div class="line">net.ipv4.tcp_window_scaling = <span class="number">1</span></div><div class="line">net.ipv4.tcp_rmem = <span class="number">4096</span> <span class="number">87380</span> <span class="number">4194304</span></div><div class="line">net.ipv4.tcp_wmem = <span class="number">4096</span> <span class="number">16384</span> <span class="number">4194304</span></div><div class="line">net.core.wmem_default = <span class="number">8388608</span></div><div class="line">net.core.rmem_default = <span class="number">8388608</span></div><div class="line">net.core.rmem_max = <span class="number">16777216</span></div><div class="line">net.core.wmem_max = <span class="number">16777216</span></div><div class="line">net.core.netdev_max_backlog = <span class="number">262144</span></div><div class="line">net.core.somaxconn = <span class="number">262144</span></div><div class="line">net.ipv4.tcp_max_orphans = <span class="number">3276800</span></div><div class="line">net.ipv4.tcp_max_syn_backlog = <span class="number">262144</span></div><div class="line">net.ipv4.tcp_timestamps = <span class="number">0</span></div><div class="line">net.ipv4.tcp_synack_retries = <span class="number">1</span></div><div class="line">net.ipv4.tcp_syn_retries = <span class="number">1</span></div><div class="line">net.ipv4.tcp_tw_recycle = <span class="number">1</span></div><div class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span></div><div class="line">net.ipv4.tcp_mem = <span class="number">94500000</span> <span class="number">915000000</span> <span class="number">927000000</span></div><div class="line">net.ipv4.tcp_fin_timeout = <span class="number">1</span></div><div class="line">net.ipv4.tcp_keepalive_time = <span class="number">30</span></div><div class="line">net.ipv4.ip_local_port_range = <span class="number">1024</span> <span class="number">65000</span></div></pre></td></tr></table></figure>

<h4 id="简单的nginx配置文件">简单的nginx配置文件</h4>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">user www www;</div><div class="line">worker_processes <span class="number">8</span>;</div><div class="line">worker_cpu_affinity <span class="number">00000001</span> <span class="number">00000010</span> <span class="number">00000100</span> <span class="number">00001000</span> <span class="number">00010000</span> <span class="number">00100000</span></div><div class="line"><span class="number">01000000</span>;</div><div class="line">error_log /www/log/nginx_error.log crit;</div><div class="line">pid /usr/local/nginx/nginx.pid;</div><div class="line">worker_rlimit_nofile <span class="number">204800</span>;</div><div class="line"></div><div class="line">events</div><div class="line">{</div><div class="line">use epoll;</div><div class="line">worker_connections <span class="number">204800</span>;</div><div class="line">}</div><div class="line"></div><div class="line">http</div><div class="line">{</div><div class="line"><span class="keyword">include</span> mime.types;</div><div class="line">default_type application/octet-stream;</div><div class="line"></div><div class="line">charset utf-<span class="number">8</span>;</div><div class="line"></div><div class="line">server_names_hash_bucket_size <span class="number">128</span>;</div><div class="line">client_header_buffer_size <span class="number">2</span>k;</div><div class="line">large_client_header_buffers <span class="number">4</span> <span class="number">4</span>k;</div><div class="line">client_max_body_size <span class="number">8</span>m;</div><div class="line"></div><div class="line">sendfile on;</div><div class="line">tcp_nopush on;</div><div class="line"></div><div class="line">keepalive_timeout <span class="number">60</span>;</div><div class="line"></div><div class="line">fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=<span class="number">1</span><span class="symbol">:</span><span class="number">2</span> keys_zone=<span class="constant">TEST</span><span class="symbol">:</span><span class="number">10</span>m inactive=<span class="number">5</span>m;</div><div class="line">fastcgi_connect_timeout <span class="number">300</span>;</div><div class="line">fastcgi_send_timeout <span class="number">300</span>;</div><div class="line">fastcgi_read_timeout <span class="number">300</span>;</div><div class="line">fastcgi_buffer_size <span class="number">4</span>k;</div><div class="line">fastcgi_buffers <span class="number">8</span> <span class="number">4</span>k;</div><div class="line">fastcgi_busy_buffers_size <span class="number">8</span>k;</div><div class="line">fastcgi_temp_file_write_size <span class="number">8</span>k;</div><div class="line"></div><div class="line">fastcgi_cache <span class="constant">TEST</span>;</div><div class="line">fastcgi_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;</div><div class="line">fastcgi_cache_valid <span class="number">301</span> <span class="number">1</span>d;</div><div class="line">fastcgi_cache_valid any <span class="number">1</span>m;</div><div class="line">fastcgi_cache_min_uses <span class="number">1</span>;</div><div class="line">fastcgi_cache_use_stale error timeout invalid_header http_50<span class="number">0</span>;</div><div class="line"></div><div class="line">open_file_cache max=<span class="number">204800</span> inactive=<span class="number">20</span>s;</div><div class="line">open_file_cache_min_uses <span class="number">1</span>;</div><div class="line">open_file_cache_valid <span class="number">30</span>s;</div><div class="line"></div><div class="line">tcp_nodelay on;</div><div class="line"></div><div class="line">gzip on;</div><div class="line">gzip_min_length <span class="number">1</span>k;</div><div class="line">gzip_buffers <span class="number">4</span> <span class="number">16</span>k;</div><div class="line">gzip_http_version <span class="number">1.0</span>;</div><div class="line">gzip_comp_level <span class="number">2</span>;</div><div class="line">gzip_types text/plain application/x-javascript text/css application/xml;</div><div class="line">gzip_vary on;</div><div class="line"></div><div class="line">server</div><div class="line">{</div><div class="line">listen <span class="number">8080</span>;</div><div class="line">server_name backup.aiju.com;</div><div class="line">index index.php index.htm;</div><div class="line">root /www/html/;</div><div class="line"></div><div class="line">location /status</div><div class="line">{</div><div class="line">stub_status on;</div><div class="line">}</div><div class="line"></div><div class="line">location ~ .*.(php|php5)?<span class="variable">$</span></div><div class="line">{</div><div class="line">fastcgi_pass <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="symbol">:</span><span class="number">9000</span>;</div><div class="line">fastcgi_index index.php;</div><div class="line"><span class="keyword">include</span> fcgi.conf;</div><div class="line">}</div><div class="line"></div><div class="line">location ~ .*.(gif|jpg|jpeg|png|bmp|swf|js|css)<span class="variable">$</span></div><div class="line"></div><div class="line">{</div><div class="line">expires <span class="number">30</span>d;</div><div class="line">}</div><div class="line"></div><div class="line">log_format access ‘<span class="variable">$remote_addr</span> – <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] “<span class="variable">$request</span>” ‘</div><div class="line">‘<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> “<span class="variable">$http_referer</span>” ‘</div><div class="line">‘”<span class="variable">$http_user_agent</span>” <span class="variable">$http_x_forwarded_for</span>’;</div><div class="line">access_log /www/log/access.log access;</div><div class="line">}</div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="FastCGi介绍">FastCGi介绍</h4>
<p>关于FastCGI 的几个指令：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=<span class="number">1</span><span class="symbol">:</span><span class="number">2</span> keys_zone=<span class="constant">TEST</span><span class="symbol">:</span><span class="number">10</span>m</div><div class="line">inactive=<span class="number">5</span>m;</div><div class="line"></div><div class="line">这个指令为 <span class="constant">FastCGI</span> 缓存指定一个路径，目录结构等级，关键字区域存储时间和非活动</div><div class="line">删除时间。</div><div class="line"></div><div class="line">fastcgi_connect_timeout <span class="number">300</span>;</div><div class="line"></div><div class="line">指定连接到后端 <span class="constant">FastCGI</span> 的超时时间。</div><div class="line"></div><div class="line">fastcgi_send_timeout <span class="number">300</span>;</div><div class="line"></div><div class="line">向<span class="constant">FastCGI</span> 传送请求的超时时间，这个值是指已经完成两次握手后向<span class="constant">FastCGI</span> 传送请求的</div><div class="line">超时时间。</div><div class="line"></div><div class="line">fastcgi_read_timeout <span class="number">300</span>;</div><div class="line"></div><div class="line">接收 <span class="constant">FastCGI</span> 应答的超时时间，这个值是指已经完成两次握手后接收 <span class="constant">FastCGI</span> 应答的超时</div><div class="line">时间。</div><div class="line"></div><div class="line">fastcgi_buffer_size <span class="number">4</span>k;</div><div class="line"></div><div class="line">指定读取 <span class="constant">FastCGI</span> 应答第一部分需要用多大的缓冲区，一般第一部分应答不会超过 <span class="number">1</span>k，</div><div class="line">由于页面大小为<span class="number">4</span>k，所以这里设置为<span class="number">4</span>k。</div><div class="line"></div><div class="line">fastcgi_buffers <span class="number">8</span> <span class="number">4</span>k;</div><div class="line"></div><div class="line">指定本地需要用多少和多大的缓冲区来缓冲 <span class="constant">FastCGI</span> 的应答。</div><div class="line"></div><div class="line">fastcgi_busy_buffers_size <span class="number">8</span>k;</div><div class="line"></div><div class="line">这个指令我也不知道是做什么用，只知道默认值是fastcgi_buffers 的两倍。</div><div class="line"></div><div class="line">fastcgi_temp_file_write_size <span class="number">8</span>k;</div><div class="line"></div><div class="line">在写入fastcgi_temp_path 时将用多大的数据块，默认值是fastcgi_buffers 的两倍。</div><div class="line"></div><div class="line">fastcgi_cache <span class="constant">TEST</span></div><div class="line"></div><div class="line">开启 <span class="constant">FastCGI</span> 缓存并且为其制定一个名称。个人感觉开启缓存非常有用，可以有效降低</div><div class="line"><span class="constant">CPU</span> 负载，并且防止<span class="number">502</span> 错误。</div><div class="line"></div><div class="line">fastcgi_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;</div><div class="line">fastcgi_cache_valid <span class="number">301</span> <span class="number">1</span>d;</div><div class="line">fastcgi_cache_valid any <span class="number">1</span>m;</div><div class="line"></div><div class="line">为指定的应答代码指定缓存时间，如上例中将 <span class="number">200</span>，<span class="number">302</span> 应答缓存一小时，<span class="number">301</span> 应答缓</div><div class="line">存 <span class="number">1</span> 天，其他为 <span class="number">1</span> 分钟。</div><div class="line"></div><div class="line">fastcgi_cache_min_uses <span class="number">1</span>;</div><div class="line"></div><div class="line">缓存在fastcgi_cache_path 指令 inactive 参数值时间内的最少使用次数，如上例，如果在</div><div class="line"><span class="number">5</span> 分钟内某文件 <span class="number">1</span> 次也没有被使用，那么这个文件将被移除。</div><div class="line"></div><div class="line">fastcgi_cache_use_stale error timeout invalid_header http_50<span class="number">0</span>;</div><div class="line"></div><div class="line">不知道这个参数的作用，猜想应该是让 nginx 知道哪些类型的缓存是没用的。</div><div class="line">以上为nginx 中<span class="constant">FastCGI</span> 相关参数，另外，<span class="constant">FastCGI</span> 自身也有一些配置需要进行优化，如</div><div class="line">果你使用 php-fpm 来管理 <span class="constant">FastCGI</span>，可以修改配置文件中的以下值：</div><div class="line"></div><div class="line"><span class="number">60</span></div><div class="line"></div><div class="line">同时处理的并发请求数，即它将开启最多<span class="number">60</span> 个子线程来处理并发连接。</div><div class="line"></div><div class="line"><span class="number">102400</span></div><div class="line"></div><div class="line">最多打开文件数。</div><div class="line"></div><div class="line"><span class="number">204800</span></div><div class="line"></div><div class="line">每个进程在重置之前能够执行的最多请求数。</div><div class="line"></div><div class="line">下面贴几张测试结果图。</div><div class="line"></div><div class="line">静态页面为我在 squid 配置<span class="number">4</span>W 并发那篇文章中提到的测试文件，下图为同时在<span class="number">6</span> 台机</div><div class="line"></div><div class="line">器运行webbench -c <span class="number">30000</span> -t <span class="number">600</span> <span class="symbol">http:</span>/<span class="regexp">/backup.aiju.com:8080/index</span>.html 命令后</div><div class="line">的测试结果：</div><div class="line"></div><div class="line">使用 netstat 过滤后的连接数：</div><div class="line"></div><div class="line">php 页面在status 中的结果 （php 页面为调用 phpinfo）：</div><div class="line"></div><div class="line">php 页面在 netstat 过滤后的连接数：</div><div class="line"></div><div class="line">未使用 <span class="constant">FastCGI</span> 缓存之前的服务器负载：</div><div class="line"></div><div class="line">此时打开 php 页面已经有些困难，需要进行多次刷新才能打开。上图中 cpu<span class="number">0</span> 负载偏低</div><div class="line">是因为测试时将网卡中断请求全部分配到 cpu<span class="number">0</span> 上，并且在 nginx 中开启<span class="number">7</span> 个进程分别制定</div><div class="line">到cpu1-<span class="number">7</span>。</div><div class="line">使用 <span class="constant">FastCGI</span> 缓存之后：</div><div class="line"></div><div class="line">此时可以很轻松的打开 php 页面。</div><div class="line">这个测试并没有连接到任何数据库，所以并没有什么参考价值，不过不知道上述测试是</div><div class="line">否已经到达极限，根据内存和 cpu 的使用情况来看似乎没有，但是已经没有多余的机子来让</div><div class="line">我运行webbench 了。囧</div></pre></td></tr></table></figure>

<p>参考资料：</p>
<p><a href="http://blog.chinaunix.net/u3/105004/showart_2087155.html" target="_blank" rel="external">http://blog.chinaunix.net/u3/105004/showart_2087155.html</a></p>
<p><a href="http://nginx.179401.cn/" target="_blank" rel="external">http://nginx.179401.cn/</a></p>
<p><a href="http://blog.s135.com/nginx_php_v5/" target="_blank" rel="external">http://blog.s135.com/nginx_php_v5/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://cloudbps.com/2015/01/10/nginx_tun/" data-id="z1ppm0ookrmm9kxx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WEB服务器/">WEB服务器</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2015/01/10/cdn/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CDN介绍(来自又拍云存储)</div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Tom.liu<br>
      <a href="https://github.com/ken8203/hexo-theme-alberta" target="_blank">Alberta</a> by <a href="http://jaychung.tw" target="_blank">jaychung</a>. Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Thank <a href="http://subtlepatterns.com/" target="_blank">Subtlepatterns</a>
    </div>
  </div>
</footer>
    </div>
    
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//imsky.github.io/holder/holder.js"></script>

  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>