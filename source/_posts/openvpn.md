title: Openvpn
date: 2013-12-29 22:16:33
categories: Openvpn
comments: true
tags:
        - VPN

---

##安装环境
centos6.4_x86最小化安装

**NOTE:**
```python
如果是在VPS中需要通过以下的命令来查看是否支持tun,如果不支持联系vps供应商
cat /dev/net/tun
返回以下说明支持tun：
cat: /dev/net/tun: File descriptor in bad state

```

##一.环境设置和相关软件：
1.1关闭selinux,由于主机名在此环境中已经设置好了，如果有需要可自行修改

```ruby   
   setenforce 0
   
   sed -i 's/SELINUX=enforcing/SELINUX=permissive/' /etc/sysconfig/selinux
```

<!--more-->
1.2安装一下软件包
```python
ntp
openssl
lzo
pam
pam-devel
pam_mysql
mysql
mysql-server
pkcs11-helper
openvpn
```
##二.创建/etc/pam.d/openvpn
```python
auth sufficient pam_mysql.so user=vpn passwd=Tom.liu host=localhost db=openvpn table=openuser usercolumn=username passwdcolumn=password where=active=1 sqllog=1 crypt=2
account required pam_mysql.so user=vpn passwd=Tom.liu host=localhost db=openvpn table=openuser usercolumn=username passwdcolumn=password where=active=1 sqllog=1 crypt=2
```
##三.创建openpn数据库
```python
1)创建测试用户
create database openvpn char set utf8;

2)授权用户
grant all on openvpn.* to vpn@localhost identified by 'Tom.liu';

3)创建openuser表
CREATE TABLE IF NOT EXISTS `openuser` (   `username` char(32) COLLATE utf8_unicode_ci NOT NULL,   `password` char(128) COLLATE utf8_unicode_ci DEFAULT NULL,   `active` int(10) NOT NULL DEFAULT '1',   `creation` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,   `name` varchar(32) COLLATE utf8_unicode_ci NOT NULL,   `email` char(128) COLLATE utf8_unicode_ci DEFAULT NULL,   `note` text COLLATE utf8_unicode_ci,   `quota_cycle` int(10) NOT NULL DEFAULT '30',   `quota_bytes` bigint(20) NOT NULL DEFAULT '10737418240',   `enabled` int(10) NOT NULL DEFAULT '1',   PRIMARY KEY (`username`),   KEY `idx_active` (`active`),   KEY `idx_enabled` (`enabled`) ) DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


4)添加用户
insert into openuser (username,password) value ('username',password('password'));

5)测试pam_mysql
安装以下软件包
5.1）yum install cyrus-sasl cyrus-sasl-plain cyrus-sasl-devel cyrus-sasl-lib cyrus-sasl-gssapi 安装测试mysql-openvpn的连通性
    /etc/init.d/saslauthd restart

5.2）模板中默认已经建立好一个test用户  密码为：testing
testsaslauthd -u test -p inspur -s openvpn
**返OK "Success"表示pam_mysql验证通过
```
##四.openvpn设置
```python
1)同步时间
ntpdata 202.120.2.101 
2)证书从vm模板中/etc/openvpn/keys获取，连同openvpn-auth-pam.so一起传输到openserver的/etc/openvpn下,因为2.1之后的openvpn-auth-pam.so模块bug不能使用。只能从低版本的编译然后替换
3)创建/etc/openvpn/server.conf
port 1194
proto tcp
dev tun
ca  /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/server.crt
key /etc/openvpn/keys/server.key
dh /etc/openvpn/keys/dh2048.pem
server 192.168.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "dhcp-option DNS 8.8.8.8"
client-to-client
;duplicate-cn    #如果需要一个帐号并发登录需要启用这个选项。
keepalive 10 120
comp-lzo
user nobody
group nobody
persist-key
persist-tun
status /var/log/openvpn-status.log
log         /var/log/openvpn.log
log-append  /var/log/openvpn.log
verb 3
plugin ./openvpn-auth-pam.so openvpn
client-cert-not-required
username-as-common-name
```
##五.安全策略
```python
1.关闭不需要的服务
for i in iscsi ip6tables saslauthd;do /etc/init.d/$i stop && chkconfig $i off;done

2.防火墙策略
# Generated by iptables-save v1.4.7 on Tue Dec 24 08:51:36 2013
*nat
:PREROUTING ACCEPT [1047:215483]
:POSTROUTING ACCEPT [50:3437]
:OUTPUT ACCEPT [50:3437]
-A POSTROUTING -s 192.168.0.0/24 -j MASQUERADE
COMMIT
# Completed on Tue Dec 24 08:51:36 2013
# Generated by iptables-save v1.4.7 on Tue Dec 24 08:51:36 2013
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [42:4856]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A INPUT -i tun+ -j ACCEPT
-A INPUT -p tcp --dport 1194 -j ACCEPT
-A INPUT -p udp --dport 1194 -j ACCEPT
-A INPUT -p icmp -j ACCEPT 
-A INPUT -i lo -j ACCEPT 
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT 
-A INPUT -j REJECT --reject-with icmp-host-prohibited 
-A FORWARD -i tun+ -j ACCEPT
-A FORWARD -d 192.168.0.0/24 -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-host-prohibited 
-A OUTPUT -s 192.168.0.0/24 -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -p icmp --icmp-type 1 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 8 -j ACCEPT
COMMIT
# Completed on Tue Dec 24 08:51:36 2013
```
##六.数据备份

1.备份脚本为mysql.sh内容为
```python
#!/bin/bash
#define some path
mysqldumppath=/usr/bin/mysqldump
gzippath=/bin/gzip
mysqluser=vpn
mysqlpasswd=Tom.liu
database=`mysql -u$mysqluser -p$mysqlpasswd -B -e  "show databases"|egrep -v '(Database|information_schema|test)'`
backpath=/back
datatime=`date +%Y%m%d`
sdatatime=`date --date '7 days ago' +'%Y%m%d'`
LOCKFILE=/tmp/$(basename $0)_lock
#Rsyncpath=/usr/local/bin/rsync

#mysqldump is script
if [ -f $LOCKFILE ];then
          pid=`cat $LOCKFILE`
          [ -n $pid ] && ps -p $pid |grep $pid > /dev/null
          [ $? = 0 ] && echo "script is runing" && exit 1
     else
          echo $$ >> $LOCKFILE
fi

mysqldump() {
     if [ -d $backpath ];then
                  echo "start backup"
               else
                    mkdir $backpath
     fi
     for i in $database;do
          $mysqldumppath -u$mysqluser -p$mysqlpasswd $i  |$gzippath -9 > ${backpath}/${i}_${datatime}.gz
     done
     }


#clear 5 days databases
mysqlclear() {
     rm -f ${backpath}/*_${sdatatime}.gz
          }

mysqldump && sleep 3  && mysqlclear
rm -f $LOCKFILE
```


##七.客户端配置文件client配置

##### **linux环境client.conf**

```python
client
dev tun
proto tcp
remote 8.8.8.8 1194
ca ca.crt
persist-key
persist-tun
ns-cert-type server
comp-lzo
verb 3
redirect-gateway def1
route-method exe
route-delay 2
auth-user-pass
script-security 2
up ./update-resolv-conf
down ./update-resolv-conf

```
##### **windows环境client.ovpn**
```python
client
dev tun
proto tcp
remote 8.8.8.8 1194
ca ca.crt
persist-key
persist-tun
ns-cert-type server
comp-lzo
verb 3
redirect-gateway def1
route-method exe
route-delay 2
auth-user-pass
script-security 2 system

```





##八.流量统计












##九.常见问题

#####server端问题
1. 由于openvpn2.1 以后的openvpn-auth-pam.so 存在bug，无法认证通过，通过日志查看 'test' faile的提示
这时需要去编译2.0.9或者2.0.7的openvpn-auth-pam.so，然后覆盖当前的.

---
#####client端问题
1. windows 7无法添加路由，openvpn-gui-2.1.1-client兼容性的问题，需要设置兼容性为windows xp sp3
2. linux 登录openvpn server 无法push server的dns，需要在client.conf中添加以下参数
	up ./update-resolv-conf
	down ./update-resolv-conf
	
